---
title: "Desarrollo del sistema financiero y crecimiento económico en Costa Rica"
author: "Fabián Brenes Trejos"
date: "18/1/2022"
output:
  xaringan::moon_reader:
    css: [xaringan-themer.css, width.css, estilo.css]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r xaringan-themer, include=FALSE, warning=FALSE}

library(xaringanthemer)

style_duo_accent(primary_color = "#1f7aff", #Color numeración
                 text_bold_color = "#1f7aff", #Texto resaltados
                 secondary_color = "#020100", #Fondo subsecciones 
                 inverse_header_color = "#FFFFFF", 
                 title_slide_background_color = "#FFFFFF", #Fondo blanco
                 header_color = "#1f7aff", #Titulo
                 title_slide_text_color = "#020100", #Titulo
                 background_color = "#FFFFFF",
                 header_font_google = google_font("Oswald"),
                 text_font_google   = google_font("Montserrat", "300", "300i"),
                 code_font_google   = google_font("Fira Mono"),
                 text_font_size = "1rem",
                 header_h1_font_size = "2.75rem",
                 header_h2_font_size = "1.75rem",
                 header_h3_font_size = "1.25rem",
                 table_row_even_background_color = "#FFFFFF"
)

```

```{r libs, include=FALSE}
#libs======================
library(tidyverse)
library(readxl)
library(dygraphs)
library(xts)
library(forecast)
library(ggiraph)
library(plotly)
library(lubridate)
library(urca)
library(zoo)
library(car)
library(kableExtra)
library(lmtest)
library(vars)
library(latex2exp)
library(tikzDevice)
library(gtsummary)
library(multDM)
library(cowplot)
library(DT)
library(ggfan)
library(gridExtra)

```

```{r datos, include=FALSE}
#Cargar datos====================
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
load(file = "../Datos/data.RData")
load(file = "../Datos/data_diff.RData")

proy_2021 <- read_excel("../Datos/datos.xlsx",
                        sheet = "proyeccion",
                        range = "A1:I125",
                        col_types = c("date",rep("numeric", 8)))

historical_data <- read_excel("../Datos/datos.xlsx",
                              sheet = "proyeccion",
                              range = "J1:S121",
                              col_types = c("date", rep("numeric", 9))) %>% 
  select(fecha, pibr, des.sf)
  
proy_2021$fecha <- as.Date(proy_2021$fecha)
historical_data$fecha <- as.Date(historical_data$fecha)

proy_2021 <- proy_2021[(nrow(proy_2021) - 3):nrow(proy_2021), ]

```

```{r modelos, include=FALSE}
#Modelos===================
var <- VAR(dplyr::select(data, cpib.cri, des.sf),
           type = "both",
           lag.max = 12, 
           ic = "AIC", 
           exogen = dplyr::select(data, apert_comercial, cpib.usa, inflacion, tbp, vartc, est.d2, est.d3, est.d4))

var_2020 <- VAR(data %>% filter(fecha < "2020-03-01") %>% dplyr::select(cpib.cri, des.sf) ,
                type = "both",
                lag.max = 12,
                ic = "AIC",
                exogen = data %>% filter(fecha < "2020-03-01") %>% dplyr::select(apert_comercial, cpib.usa, inflacion, tbp, vartc, est.d2, est.d3, est.d4))

summary(var)

vecm <- ca.jo(data %>% dplyr::select(cpib.cri, des.sf),
              type = "eigen",
              K = 5, 
              dumvar = dplyr::select(data, apert_comercial, cpib.usa, inflacion, tbp, vartc, est.d2, est.d3, est.d4, tendencia),
              spec = "longrun") 

vecm.level <- vec2var(vecm, 1)
vecm.r1 <- cajorls(vecm, r = 1)

```

```{r funciones, include=FALSE}

#funciones graficos==================
graf_lin <- function(mydata, fecha, var, tit, lab, ylab) {
  
  mydata %>% 
    select(!!fecha, !!var) %>% 
    column_to_rownames(fecha) %>% as.xts() %>% 
    dygraph(main = tit) %>% 
    dyAxis("x", drawGrid = FALSE, label = "Fecha") %>%
    dyAxis("y", drawGrid = FALSE, label = ylab) %>%
    dySeries(var, label = lab, color = "#1f7aff") %>% 
    dyOptions(axisLineWidth = 1.5, fillGraph = TRUE, drawGrid = FALSE)
}

tab_descriptivos <- function(mydata, var, dgts) {
  
  var <- enquo(var)
  tab <- mydata %>% 
    summarize(indicador = 1,
              'Mínimo' = min(!!var), 
              'Máximo' = max(!!var), 
              Promedio = mean(!!var),
              'Desviación Estándar' = sd(!!var)) %>% 
    pivot_longer(-indicador, names_to = "Estadístico", values_to = "Valor") %>% 
    select(-indicador)
  
  kable(tab, digits = dgts,  format = 'html', booktabs = T, 
        caption = "Estadísticas Descriptivas") %>%
    kable_classic("hover", full_width = F, font_size = 12) %>% 
    column_spec(1, width = "9cm") %>% 
    column_spec(2, width = "4cm")
  
}  

#Funciones para las simulaciones=======================


generar_datos_sim1 <- function(variable, q.inf, q.sup) {
  
  nombres <- c("fecha", "apert_comercial", "cpib.usa", "inflacion", "tbp", "vartc",
               "est.d2", "est.d3", "est.d4") 
  var <- sym(variable)
  
  pos <- which(nombres == as_label(var))
  
  mydata <- data %>% dplyr::select(fecha, {{var}}) %>% 
    group_by(quarter(fecha)) %>% 
    summarize(lim.inf = quantile(x = {{var}}, q.inf),
              lim.sup = quantile(x = {{var}}, q.sup), 
              sim = runif(1, lim.inf, lim.sup))
  
  mydata <- bind_cols(proy_2021 %>% select(-{{var}}),
                      mydata %>% select(sim)) %>% 
    relocate(sim, .before = pos)
  
  colnames(mydata) <- nombres
  
  mydata <- mydata %>% select(-fecha)
  
  return(mydata)  
}

generar_datos_sim2 <- function(data, variable, q.inf, q.sup) {
  
  mydata <- data %>% dplyr::select(fecha, {{variable}}) %>% 
    group_by(quarter(fecha)) %>% 
    summarize(lim.inf = quantile(x = {{variable}}, q.inf),
              lim.sup = quantile(x = {{variable}}, q.sup), 
              sim = runif(1, lim.inf, lim.sup))
  
  return(mydata$sim)  
}

generar_determ <- function(fecha1, tendencia1){
  
  tibble(periodo = 1:4,
         fecha = add_with_rollback(fecha1, months(periodo * 3)),
         est.d2 = ifelse(quarter(fecha) == 2, 1, 0),
         est.d3 = ifelse(quarter(fecha) == 3, 1, 0),
         est.d4 = ifelse(quarter(fecha) == 4, 1, 0),
         tendencia = tendencia1 + periodo) %>% 
    select(-c(periodo, fecha))
}


```

## CONTENIDO

- Introducción 
<br>

- Objetivos <br>    

- Métodos y datos <br>

- Resultados <br>

    + Modelo VAR <br>
    
    + Análisis de cointegración <br>
    
    + Modelo VECM <br>
    
    + Comparativo VAR y VECM <br>
    
    + Resultados de la simulación <br>

- Conclusiones

---

class: inverse, center, middle

# INTRODUCCIÓN

---

## Relación teórica entre sistema financiero y crecimiento económico

.pull-left.w10[]

.pull-right.w80[

```{r, echo=FALSE}
DiagrammeR::grViz("digraph {
  graph [layout = dot, rankdir = TB]
  
  node [shape = rectangle]        
  rec1 [label = 'Imperfecciones de mercado']
  rec2 [label = 'Mercados e intermediarios financieros']
  rec3 [label =  'Acumulación de capital']
  rec4 [label = 'Innovación tecnológica']
  rec5 [label = 'Crecimiento económico']
  
  # edge definitions with the node IDs
  rec1 -> rec2 -> rec3 ; rec2 -> rec4; rec3 -> rec5; rec4 -> rec5 
  }",
  height = 400)
```
]

---

## Justificación del estudio

- El sistema financiero en Costa Rica empezó a modernizarse en la década de los 80, con reformas de desregulación. 
<br> 
<br>

--

- No obstante, estudios demuestran que el sistema no ha alcanzado suficiente desarrollo.
 + Mercado concentrado
 + Altos niveles de márgenes de intermediación 
<br>
<br>
 
--

**¿Cuál es la relación entre el desarrollo del sistema financiero costarricense con respecto al crecimiento económico experimentado de 1997 a 2020?**

---

## Objetivos

### General
Estudiar la relación entre el desarrollo del sistema financiero y el crecimiento económico mediante modelos de series temporales multivariados, para el caso de Costa Rica, en el periodo 1997 - 2020.

### Específicos
- .small[Conocer tendencias, valores atípicos y correlaciones mediante un análisis exploratorio.]
<br>

- .small[Analizar los supuestos de estacionariedad por medio de análisis gráfico y pruebas estadísticas.]
<br>

- .small[Estudiar la cointegración entre las variables a partir de un modelo de vectores autorregresivos (VAR).]
<br>

- .small[Estimar los parámetros de cointegración con base en un modelo de corrección
de error vectorial (VECM).]

- .small[Identificar políticas para impulsar el crecimiento económico, mediante un estudio de simulaciones con el modelo ajustado.]

---

class: inverse, center, middle

# MÉTODOS Y DATOS

---

class: inverse, center, middle

# DATOS

---

## Muestra y variables

### Muestra:

+ Primer timestre 2000 - cuarto trimestre 2020
+ Fuente: Banco Central de Costa Rica y  Oficina de Análisis Económico de EUA

### Variables de estudio:

+ Crecimiento interanual de la economía
+ Desarollo del sistema financiero

### Covariables:

+ Apertura Comercial
+ Producto Interno Bruto real de EUA (variación interanual)
+ Inflación
+ Tasa Básica Pasiva
+ Tipo de Cambio (variación internual)

---

## Crecimiento internual de la economía

Cálculo: $log(PIB_t / PIB_{t-4})$ 

.pull-left.w60[
```{r, echo=F, fig.width=6, fig.height=6}

graf_lin(data, "fecha", "log_pibryoy",
         " ",
         "Valor",
         "Crecimiento anual")

```
]

.pull-right.w40[
```{r, echo=FALSE, fig.align='center', eval=T}

pibr_df <- ur.df(data$log_pibryoy, type = "trend", selectlags = "AIC")

pibr_diff_df <- ur.df(data_diff$log_pibryoy_diff, type = "drift", selectlags = "AIC") 

tab <- tibble("Estadístico" = round(t(pibr_df@teststat)[, 1], 2) , 
                 pibr_df@cval %>% as_tibble()) %>% 
  bind_rows(tibble("Estadístico" = round(t(pibr_diff_df@teststat)[, 1], 2),
                  pibr_diff_df@cval %>% as_tibble())) %>% 
  mutate(`Parámetro` = c("$\\tau_3$", "$\\phi_2$", "$\\phi_3$", "$\\tau_2$", "$\\phi_1$")) %>% 
  relocate(`Parámetro`, .before = "Estadístico")

kable(tab, 
      booktabs = TRUE, caption = "Prueba Dickey-Fuller",
      label = "DF_niveles") %>%
  kable_classic("hover", full_width = F, font_size = 12)  %>% 
  column_spec(1, width = "10em") %>% 
  add_header_above(c("", "", "Valores Críticos"  = 3)) %>% 
  pack_rows("En niveles", 1, 3) %>% 
  pack_rows("En primeras diferencias", 4, 5)

```
]

---

## Desarrollo del sistema financiero

Cálculo: $\mbox{Créditos al sector privado no financiero} / \mbox{PIB nominal}$

.pull-left.w60[
```{r, echo=F, fig.width=6, fig.height=6}

graf_lin(data, "fecha", "des.sf",
         " ",
         "Valor",
         "Términos del PIB")

```
]
.pull-right.w40[
```{r, echo=FALSE, fig.align='center', eval=T}
cred_pib_df <- ur.df(data$cred_pib, type = "trend", selectlags = "AIC")

cred_pib_diff_df <- ur.df(data_diff$cred_pib_diff, type = "drift", selectlags = "AIC") 

tab <- tibble("Estadístico" = round(t(cred_pib_df@teststat)[, 1], 2) , 
                 cred_pib_df@cval %>% as_tibble()) %>% 
  bind_rows(tibble("Estadístico" = round(t(cred_pib_diff_df@teststat)[, 1], 2),
                  cred_pib_diff_df@cval %>% as_tibble())) %>% 
  mutate(`Parámetro` = c("$\\tau_3$", "$\\phi_2$", "$\\phi_3$", "$\\tau_2$", "$\\phi_1$")) %>% 
  relocate(`Parámetro`, .before = "Estadístico")

kable(tab, 
      booktabs = TRUE, caption = "Prueba Dickey-Fuller",
      label = "DF_niveles") %>%
  kable_classic("hover", full_width = F, font_size = 12)  %>% 
  column_spec(1, width = "10em") %>% 
  add_header_above(c("", "", "Valores Críticos"  = 3)) %>% 
  pack_rows("En niveles", 1, 3) %>% 
  pack_rows("En primeras diferencias", 4, 5)
```
]

---

## Covariables

```{r, echo = FALSE, fig.width=10, fig.height=7, fig.align = 'center'}

#Función
graf_agrup <- function(mydata, var, ytit, tit) {
  
  var <- enquo(var)
  ggplot(data = data, aes(x = fecha, y = !!var)) + 
  geom_line(size = 0.25, colour = "#1f7aff") +
  ylab(ytit) + 
  ggtitle(tit) + 
  theme_classic() %+replace% 
  theme(plot.title = element_text(size = 12), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(angle = 90, size = 10, 
                                    margin = margin(t = 0, r = 5, b = 0, l = 0)), 
        axis.text.y = element_text(size = 10))
  
}


#Grafico apertura comercial=========================
g_apertcomercial <- graf_agrup(data, apert_comercial, "Porcentaje del PIB", 
                               "Apertura Comercial")

#Grafico crecimiento del PIB USA=========================
g_pibusa <- graf_agrup(data, log_pibusayoy, "Var. anual",
                       "PIB Real de EUA")

#Grafico de variación del tipo de cambio=========================
g_vartc <- graf_agrup(data, vartc, "Var. Anual",
                      "Tipo de Cambio")
  
#Grafico TBP===================
g_tbp <- graf_agrup(data, tbp, "Porcentaje",
                    "Tasa Básica Pasiva")
  
#Grafico inflación===================
g_inflacion <- graf_agrup(data, inflacion, "Var. Anual",
                          "Inflación")

#Graficos agrupados
grid.arrange(g_apertcomercial, g_pibusa, g_vartc, g_tbp, g_inflacion) 


```

---

## Matriz de correlaciones

```{r, echo=FALSE}

cormat <- data %>% 
  select(cpib.cri, des.sf, apert_comercial, cpib.usa, inflacion, tbp, vartc) %>% 
  cor() %>% 
  round(2)

nombres <- c("Crecimiento Económico", "Desarrollo del Sistema Financiero", "Apertura Comercial", "PIB de EUA (var. anual)", "Inflación", "TBP", "Tipo de Cambio (var. anual)")
colnames(cormat) <- nombres
row.names(cormat) <- nombres

kable(cormat, booktabs = TRUE, 
             label = "cormat") %>%
  kable_classic("hover", full_width = F, font_size = 18) %>% 
  column_spec(1, width = "10em") 

```

---

class: inverse, center, middle

# MÉTODOS

---

## Modelos VAR

$$\mathbf{y}_t = A_1\mathbf{y}_{t-1} + \cdots + A_p\mathbf{y}_{t-p} + CD_t + \mathbf{u}_t$$
<br>
<br>
En donde:
+ $\mathbf{y}_t$: Es un vector de $K$ variables endógenas $(\mathbf{y}_t = y_{1t}, \ldots, y_{kt}, \ldots, y_{Kt})$
<br>
<br>
+ $A_i$: Es una matriz de coeficientes de tamaño $(K \times K)$ con $i = 1,\ldots, p$
<br>
<br>
+ $\mathbf{u}_t$: Es un vector de procesos ruido blanco e invariante en el tiempo de $K$ dimensiones y covarianza definida y positiva $E(\mathbf{u}_t \mathbf{u}'_t) = \sum{u}$
<br>
<br>
+ $C$: Es una matriz de coeficientes de potenciales regresores determinísticas de tamaño $(K \times M)$ y $D_t$ son las variables determinísticas asociadas a $C$

---

## Modelos VAR: Causalidad de Granger

Se define que una variable $Y_t$ causa $X_t$, si la predicción de $X_t$ resulta más certera utilizando toda la información disponible, que la predicción de $X_t$ excluyendo $Y_t$. 
<br>
<br>
$$\sigma^2(X|U) < \sigma^2 (X|\overline{U-Y})$$
<br>
<br>
En donde: 
+ $U$: Representa toda la información disponible. 
+ $\overline{Y}$: Valores pasados de $Y$. 

---

## VECM

+ En series de tiempo económicas, es recurrente que no sean estacionarias de orden 0 y que tengan tendencia. En estos casos, la regresión de las variables en niveles puede llevar a una regresión espúrea. 
<br>

--

+ Si el residuo de la regresión con variables no estacionarias es estacionario, se afirma que las series **cointegran** en el largo plazo, ya que existe una combinación lineal entre las variables que da como resultado un residuo con un orden de integración menor al de las variables en cuestión.
<br>

--

$$\Delta y_t = \Gamma_1 \Delta y_{t-1} + \dots + \Gamma_{p-1}\Delta y_{t-p+1} + \Pi y_{t-p} + \mu + \Phi D_t + \epsilon_t$$
<br>

--

+ $0 < rk(\Pi) = r < K$: Implica que hay matrices $\alpha$ y $\beta$ de tamaño $r \times K$ tal que $\Pi = \alpha \beta'$. Por esta razón, $\alpha \beta' y_{t-p}$ es estacionaria. El rango de $\Pi$ corresponde al grado de cointegración del vector de variables $y_t$.

---

class: inverse, center, middle

# RESULTADOS

---

## Análisis de cointegración

Se estiman 2 modelos y se analiza el parámetro $\Pi$:

1. Modelo sin covariables:
$$\Delta Y_t = \Gamma_1 \Delta Y_{t-1} + \cdots + \Gamma_{k-1} \Delta Y_{t-k+1} + \Pi Y_{t-k} + \mu + \epsilon_t$$  
2. Modelos con covariables:
$$\Delta Y_t = \Gamma_1 \Delta Y_{t-1} + \cdots + \Gamma_{k-1} \Delta Y_{t-k+1} + \Pi Y_{t-k} + \mu + \Omega X_t + \epsilon_t$$

<br>
```{r, echo = FALSE}

cajo_covars <- ca.jo(data %>% dplyr::select(cpib.cri, des.sf),
                     type = "eigen",
                     K = 5, 
                     dumvar = dplyr::select(data, apert_comercial, cpib.usa, inflacion, tbp, 
                                            vartc, est.d2, est.d3, est.d4, tendencia),
                     spec = "longrun") %>% summary()

cajo_simple <- ca.jo(data %>% dplyr::select(log_pibryoy, cred_pib), 
      type = "eigen",  
      K = 5, 
      spec = "longrun") %>% summary()

tabla_cajo2 <- tibble(`Hipótesis` = c("r <= 1", "r = 0"), 
                      "Modelo 1" = round(cajo_simple@teststat, 2),
                      "Modelo 2" = round(cajo_covars@teststat, 2),
                      round(cajo_simple@cval, 2) %>% as_tibble())

kable(tabla_cajo2, booktabs = TRUE, 
             caption = "Rango de cointegración: Estadístico de auto-valor máximo") %>% 
  kable_classic("hover", font_size = 15, full_width = F) %>% 
  column_spec(1, width = "10em") %>% 
  add_header_above(c("", "Estadístico" = 2, "Valores Críticos" = 3))
```

---

## Modelo VAR

+ Modelo estimado:

$$\begin{alignat}{1}
    y_{1t} &= \pi_0 + \sum_{i=1}^{4}\beta_{1i}y_{1t-i} + \sum_{i=1}^{4}\beta_{2i}y_{2t-i} + X_t B_1  + \Phi_1 D_t +  S_t T_1  + \epsilon_{1t}\\
    y_{2t} &= \psi_0 + \sum_{i=1}^{4}\beta_{1i}y_{1t-i} + \sum_{i=1}^{4}\beta_{2i}y_{2t-i} + X_t B_2  + \Phi_2 D_t + S_t T_2  + \epsilon_{2t}
    \end{alignat}$$

Incluye:  

+ 4 rezagos de las variables endógenas con base al criterio de Akaike
<br>

+ cinco variables exógenas 
<br>

+ Constante 
<br>

+ Tendencia 
<br>

+ variables dicotómicas para capturar estacionalidad

---
### Modelo VAR: Coeficientes estimados y pruebas de diagnóstico

.pull-left.w45[
```{r, echo=FALSE}

tab_var <- tibble(`Parámetros` = names(var$varresult$cpib.cri$coefficients), 
                  cpib.cri = round(var$varresult$cpib.cri$coefficients, 3),
                  t1 = round(summary(var)$varresult$cpib.cri$coefficients[, "t value"], 2),
                  pvalue1 = summary(var)$varresult$cpib.cri$coefficients[, "Pr(>|t|)"],
                  stars1 = ifelse(pvalue1 <= 0.001, " ***", 
                                  ifelse(pvalue1 <= 0.01, " **", ifelse(pvalue1 <= 0.05, " *", ifelse(pvalue1 <= 0.1, ".", "")))), 
                  des.sf = round(var$varresult$des.sf$coefficients, 3), 
                  t2 = round(summary(var)$varresult$des.sf$coefficients[, "t value"], 2),
                  pvalue2 = summary(var)$varresult$des.sf$coefficients[, "Pr(>|t|)"],
                  stars2 = ifelse(pvalue2 <= 0.001, " ***", ifelse(pvalue2 <= 0.01, " **", 
                                                                   ifelse(pvalue2 <= 0.05, " *", ifelse(pvalue2 <= 0.1, ".", ""))))) %>%  
  mutate(cpib.cri = paste0(paste0(paste0(paste0(cpib.cri, " ("),t1),")"), stars1),
         des.sf = paste0(paste0(paste0(paste0(des.sf, " ("),t2),")"), stars2)) %>% 
  dplyr::select(`Parámetros`, cpib.cri, des.sf) %>% 
  column_to_rownames(var = "Parámetros")

kable(tab_var, booktabs = TRUE,
      caption = "Coeficientes estimados del modelo VAR(4)") %>% 
  kable_classic("hover", font_size = 13) %>% 
  column_spec(1, width = "3cm") %>% 
  column_spec(2, width = "3cm") %>% 
  column_spec(3, width = "3cm") %>% 
  footnote(general_title = "",
           general = c("Códigos de significancia: 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1", "Estadístico t en paréntesis"))

```
]
.pull-right.w45[

```{r, echo=FALSE}

ptm_test <- serial.test(var, type = "PT.asymptotic")
arch <- arch.test(var, multivariate.only = T)
jb <- normality.test(var, multivariate.only = T)

tabla_var_tests <- tibble(Prueba = c("Portmanteau", "ARCH", "Jarque-Bera"),
                          `Estadístico` = c(round(ptm_test$serial$statistic, 2),
                                            round(arch$arch.mul$statistic, 2), 
                                            round(jb$jb.mul$JB$statistic, 2)),
                          `Valor p` =  c(round(ptm_test$serial$p.value, 2), 
                                         round(arch$arch.mul$p.value, 2), 
                                         round(jb$jb.mul$JB$p.value, 2)))  

kable(tabla_var_tests, booktabs = TRUE, 
      caption = "Pruebas de diagnóstico del VAR") %>% 
  kable_classic("hover", font_size = 13)

```
<br>
<br>
```{r, echo=FALSE}

tab_raizes <- tibble(param = 'Valores propios',
                     val = round(roots(var), 2)) %>% 
  mutate(cons = 1:n())

tab_raizes <- tab_raizes %>% pivot_wider(param, cons, values_from = val) %>%   
  column_to_rownames("param")

kable(tab_raizes, booktabs = TRUE,
      caption = "Módulo de los valores propios de los coeficientes") %>%
  kable_classic("hover", font_size = 13)


```
<br>
<br>
```{r, echo=FALSE}

granger_cred <- causality(var, cause = "des.sf")
granger_pib <- causality(var, cause = "cpib.cri")

tabla_caus <- tibble(Prueba  = c("D.S.F causa en el sentido de Granger a C.E.", 
                                  "C.E. causa en el sentido de Granger a D.S.F"),
                     `Estadístico` = c(round(granger_cred$Granger$statistic[1, ], 3), 
                                       round(granger_pib$Granger$statistic[1, ], 3)),
                     `Valor p` = c(round(granger_cred$Granger$p.value[1, ], 3), 
                                   round(granger_pib$Granger$p.value[1, ], 3))) 

kable(tabla_caus, booktabs = TRUE,
      caption = "Prueba de Causalidad de Granger") %>% 
  kable_classic("hover", font_size = 13) %>% 
  footnote(general_title = "",
           general = c("C.E. = Crecimiento económico", 
                     "D.S.F. = Desarrollo del Sistema Financiero"))
```
]

---

### Modelo VAR: Gráficos impulso - respuesta

<br>
.pull-left.w45[
```{r, echo=FALSE}

irf1 <- irf(var,
            impulse = "des.sf",
            response = "cpib.cri",
            n.ahead = 24,
            cumulative = F)  

var_dsf_crec_simple <- tibble(irf = irf1$irf %>% unlist(), 
                              l_inf = irf1$Lower %>% unlist(),
                              l_sup = irf1$Upper %>% unlist()) %>% 
  mutate(tipo = "Efecto simple", 
         modelo = "mod1", 
         periodo = 0:(nrow(.) - 1))


var_dsf_crec_simple %>% 
  ggplot(aes(x = periodo, y = irf)) +
  geom_line(colour = "#1f7aff", size = 1) +
  scale_x_continuous(breaks = seq(0, 36, by = 4)) +
  geom_hline(yintercept = 0) +  
  geom_line(aes(x = periodo, y = l_sup), colour = "black", linetype = "dashed", size = 1) + 
  geom_line(aes(x = periodo, y = l_inf), colour = "black", linetype = "dashed", size = 1) +
  ylab("crec. econ.") +
  ggtitle("Impacto en el crec. econ a un impulso en el des. s.f. \n ") +
  theme_bw() %+replace%
  theme(legend.position = "none", 
        plot.title = element_text(size = 18),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        axis.title = element_text(size = 15), 
        axis.text=element_text(size = 15), 
        strip.text.y = element_text(size = 15))
```
]

.pull-right.w45[
```{r, echo=FALSE}

irf1 <- irf(var,
            impulse = "cpib.cri",
            response = "des.sf",
            n.ahead = 24,
            cumulative = F)  

var_crec_dsf_simple <- tibble(irf = irf1$irf %>% unlist(), 
                              l_inf = irf1$Lower %>% unlist(),
                              l_sup = irf1$Upper %>% unlist()) %>% 
  mutate(tipo = "Efecto simple", 
         modelo = "mod1", 
         periodo = 0:(nrow(.) - 1))

var_crec_dsf_simple %>% 
  ggplot(aes(x = periodo, y = irf)) +
  geom_line(colour = "#1f7aff", size = 1) +
  scale_x_continuous(breaks = seq(0, 36, by = 4)) +
  geom_hline(yintercept = 0) +  
  geom_line(aes(x = periodo, y = l_sup), colour = "black", linetype = "dashed", size = 1) + 
  geom_line(aes(x = periodo, y = l_inf), colour = "black", linetype = "dashed", size = 1) +
  ylab("Desarrollo del s.f.") +
  ggtitle("Impacto en el des. s.f. a un impulso del crec. econ. \n") +
  theme_bw() %+replace%
  theme(legend.position = "none", 
        plot.title = element_text(size = 18),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        axis.title = element_text(size = 15), 
        axis.text=element_text(size = 15), 
        strip.text.y = element_text(size = 15))
```
]

---

## VECM

.pull-left.w45[
```{r, echo=FALSE}

tab_vecm <- tibble(`Parámetros` = rownames(vecm.r1$rlm$coefficients),
                   cpib.cri = round(vecm.r1$rlm$coefficients[, 1], 3),
                   t1 = round(summary(vecm.r1$rlm)$'Response cpib.cri.d'$coefficients[, "t value"], 2),
                   pvalue1 = summary(vecm.r1$rlm)$'Response cpib.cri.d'$coefficients[, "Pr(>|t|)"],
                   stars1 = ifelse(pvalue1 <= 0.001, " ***", ifelse(pvalue1 <= 0.01, " **", 
                                                                   ifelse(pvalue1 <= 0.05, " *", ifelse(pvalue1 <= 0.1, ".", "")))), 
                  des.sf = round(vecm.r1$rlm$coefficients[, 2], 3), 
                  t2 = round(summary(vecm.r1$rlm)$'Response des.sf.d'$coefficients[, "t value"], 2),
                  pvalue2 = summary(vecm.r1$rlm)$'Response des.sf.d'$coefficients[, "Pr(>|t|)"],
                  stars2 = ifelse(pvalue2 <= 0.001, " ***", ifelse(pvalue2 <= 0.01, " **", 
                                                                   ifelse(pvalue2 <= 0.05, " *", ifelse(pvalue2 <= 0.1, ".", ""))))) %>%  
  mutate(cpib.cri = paste0(paste0(paste0(paste0(cpib.cri, " ("),t1),")"), stars1),
         des.sf = paste0(paste0(paste0(paste0(des.sf, " ("),t2),")"), stars2)) %>% 
  dplyr::select(`Parámetros`, cpib.cri, des.sf) %>% 
  column_to_rownames(var = "Parámetros")

knitr::kable(tab_vecm, booktabs = TRUE, 
             caption = "Coeficientes estimados del modelo VECM") %>% 
  kable_classic("hover", font_size = 11) %>% 
  column_spec(1, width = "3cm") %>% 
  column_spec(2, width = "3cm") %>% 
  column_spec(3, width = "3cm") %>% 
  footnote(general_title = "",
           general = c("Códigos de significancia: 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1", 
                       "Estadístico t en paréntesis"))
```
]

.pull-right.w45[
```{r, echo=FALSE}

ptm_test_vecm <- serial.test(vecm.level, type = "PT.asymptotic")
arch_vecm <- arch.test(vecm.level, multivariate.only = T)
jb_vecm <- normality.test(vecm.level, multivariate.only = T)

tabla_vecm_tests <- tibble(Prueba = c("Portmanteau", "ARCH", "Jarque-Bera"),
                          `Estadístico` = c(round(ptm_test_vecm$serial$statistic, 2),
                                            round(arch_vecm$arch.mul$statistic, 2), 
                                            round(jb_vecm$jb.mul$JB$statistic, 2)),
                          `Valor p` =  c(round(ptm_test_vecm$serial$p.value, 2), 
                                         round(arch_vecm$arch.mul$p.value, 2), 
                                         round(jb_vecm$jb.mul$JB$p.value, 2)))  

kable(tabla_vecm_tests, booktabs = TRUE, 
             caption = "Pruebas de diagnóstico del VECM") %>% 
  kable_classic("hover", font_size = 13)
```
]

---

### VECM: Gráficos impulso - respuesta

<br>
.pull-left.w45[
```{r, echo=FALSE}

irf1 <- irf(vecm.level,
            impulse = "des.sf",
            response = "cpib.cri",
            n.ahead = 24,
            cumulative = F)  

vecm_dsf_crec_simple <- tibble(irf = irf1$irf %>% unlist(), 
                               l_inf = irf1$Lower %>% unlist(), 
                               l_sup = irf1$Upper %>% unlist()) %>% 
  mutate(tipo = "Efecto simple", 
         modelo = "mod1", 
         periodo = 0:(nrow(.) - 1))

vecm_dsf_crec_simple %>% 
  ggplot(aes(x = periodo, y = irf)) +
  geom_line(colour = "#1f7aff", size = 1) +
  scale_x_continuous(breaks = seq(0, 36, by = 4)) +
  geom_hline(yintercept = 0) +  
  geom_line(aes(x = periodo, y = l_sup), colour = "black", linetype = "dashed", size = 1) + 
  geom_line(aes(x = periodo, y = l_inf), colour = "black", linetype = "dashed", size = 1) +
  ylab("crec. econ.") +
  ggtitle("Impacto en el crec. econ a un impulso en el des. s.f. \n ") +
  theme_bw() %+replace%
  theme(legend.position = "none", 
        plot.title = element_text(size = 18),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        axis.title = element_text(size = 15), 
        axis.text=element_text(size = 15), 
        strip.text.y = element_text(size = 15))

```

]

.pull-right.w45[
```{r, echo=FALSE}

irf1 <- irf(vecm.level,
            impulse = "cpib.cri",
            response = "des.sf",
            n.ahead = 24,
            cumulative = F)  

vecm_crec_dsf_simple <- tibble(irf = irf1$irf %>% unlist(), 
                               l_inf = irf1$Lower %>% unlist(), 
                               l_sup = irf1$Upper %>% unlist()) %>% 
  mutate(tipo = "Efecto simple", 
         modelo = "mod1", 
         periodo = 0:(nrow(.) - 1))

vecm_crec_dsf_simple %>% 
  ggplot(aes(x = periodo, y = irf)) +
  geom_line(colour = "#1f7aff", size = 1) +
  scale_x_continuous(breaks = seq(0, 36, by = 4)) +
  geom_hline(yintercept = 0) +  
  geom_line(aes(x = periodo, y = l_sup), colour = "black", linetype = "dashed", size = 1) + 
  geom_line(aes(x = periodo, y = l_inf), colour = "black", linetype = "dashed", size = 1) +
  ylab("Desarrollo del s.f.") +
  ggtitle("Impacto en el des. s.f. a un impulso en el crec. econ \n ") +
  theme_bw() %+replace%
  theme(legend.position = "none", 
        plot.title = element_text(size = 18),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        axis.title = element_text(size = 15), 
        axis.text=element_text(size = 15), 
        strip.text.y = element_text(size = 15))

```
]

---

### Comparativo VAR vs VECM

<br>
.pull-left.w45[

```{r, echo=FALSE}

irf_data <- tibble(VAR_crec.econ = irf(var,
                                       impulse = "des.sf",
                                       response =  "cpib.cri",
                                       n.ahead = 24,
                                       boot = F)$irf$des.sf[, 1], 
                   VECM_crec.econ = irf(vecm.level,
                                        impulse = "des.sf",
                                        response =  "cpib.cri",
                                        n.ahead = 24,
                                        boot = F)$irf$des.sf[, 1], 
                   VAR_des.sf = irf(var,
                                    impulse = "cpib.cri",
                                    response =  "des.sf",
                                    n.ahead = 24,
                                    boot = F)$irf$cpib.cri[, 1],
                   VECM_des.sf = irf(vecm.level,
                                    impulse = "cpib.cri",
                                    response = "des.sf",
                                    n.ahead = 24,
                                    boot = F)$irf$cpib.cri[, 1]) %>% mutate(periodo = 1:n())


irf_data_long <- irf_data %>% 
  pivot_longer(-periodo, names_sep = "_", names_to = c("modelo", "indicador"), values_to = "irf")

irf_data_long %>% 
  dplyr::filter(indicador == "crec.econ") %>% 
  ggplot(aes(x = periodo, y = irf, colour = modelo)) + geom_line(size = 1) +
  scale_color_manual(values = c("red", "#1f7aff")) +
  scale_x_continuous(breaks = seq(0, 24, by = 2)) +
  ylab("crec. econ.") +
  ggtitle("Impacto en el crec. econ a un impulso en el des. s.f. \n ") +
  theme_bw() %+replace%
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15),
        plot.title = element_text(size = 18),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        axis.title = element_text(size = 15), 
        axis.text=element_text(size = 15), 
        strip.text.y = element_text(size = 15))

```

]

.pull-right.w45[
```{r,echo=FALSE}

irf_data <- tibble(VAR_crec.econ = irf(var,
                                       impulse = "des.sf",
                                       response =  "cpib.cri",
                                       n.ahead = 12,
                                       boot = F)$irf$des.sf[, 1], 
                   VECM_crec.econ = irf(vecm.level,
                                        impulse = "des.sf",
                                        response =  "cpib.cri",
                                        n.ahead = 12,
                                        boot = F)$irf$des.sf[, 1], 
                   VAR_des.sf = irf(var,
                                    impulse = "cpib.cri",
                                    response =  "des.sf",
                                    n.ahead = 12,
                                    boot = F)$irf$cpib.cri[, 1],
                   VECM_des.sf = irf(vecm.level,
                                    impulse = "cpib.cri",
                                    response = "des.sf",
                                    n.ahead = 12,
                                    boot = F)$irf$cpib.cri[, 1]) %>% 
  mutate(periodo = 1:n())

irf_data_long <- irf_data %>% 
  pivot_longer(-periodo, names_sep = "_", names_to = c("modelo", "indicador"), values_to = "irf")

irf_data_long %>% 
  dplyr::filter(indicador == "des.sf") %>% 
  ggplot(aes(x = periodo, y = irf, colour = modelo)) + geom_line(size = 1) +
  scale_color_manual(values = c("red", "darkblue")) +
  scale_x_continuous(breaks = seq(0, 24, by = 2)) +
  ylab("Desarrollo del s.f.") +
  ggtitle("Impacto en el des. s.f. a un impulso en el crec. econ \n ") +
  theme_bw() %+replace%
  theme(legend.position = "bottom",
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15),
        plot.title = element_text(size = 18),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        axis.title = element_text(size = 15), 
        axis.text=element_text(size = 15), 
        strip.text.y = element_text(size = 15))
```

]

---

## Simulaciones

### 1. Análisis de Sensibilidad

.small[
**Objetivo: ** Identificar variaciones en las variables exógenas que pueden estar asociadas a fuertes desviaciones en las estimaciones de crecimiento económico y desarrollo del sistema financiero.
]

### 2. Análisis de estrés económico

.small[
**Objetivo: ** Evaluar el impacto de las variables de interés ante un escenario de crisis interna. 
]

### Escenarios base

```{r escenario_base, echo = FALSE, message=FALSE}
#Proyección 2021 con datos observados======================

escen_base <- bind_cols(tibble(Fecha = c("2021-03-01", "2021-06-01", "2021-09-01", "2021-12-01")), 
                        round(proy_2021[(nrow(proy_2021) - 3):nrow(proy_2021), -c(1, 7, 8, 9)], 4))
colnames(escen_base) <- c("Fecha", "Apertura Comercial", "PIB USA", "Inflación", "TBP", "Tipo de Cambio (var. anual)")

pred_base_2021 <- predict(var,
                          dumvar = proy_2021[(nrow(proy_2021) - 3):nrow(proy_2021), -1],
                          n.ahead = 4)

#Crecimiento del PIB
pred_cpib <- proy_2021 %>% filter(fecha > "2020-12-01") %>% select(fecha) %>% 
  bind_cols(pred_base_2021$fcst$cpib.cri %>% as_tibble) %>% 
  select(-CI) %>% 
  bind_rows(tibble(fecha = date("2020-12-01"), 
                   fcst = data %>%
                     select(fecha, cpib.cri) %>% 
                     filter(fecha == "2020-12-01") %>% 
                     select(-fecha) %>% 
                     as.numeric(), 
                   lower = fcst, 
                   upper = fcst))

pred_cpib_long <- pred_cpib %>% 
  pivot_longer(-fecha, names_to = "tipo", values_to = "valor") %>% 
  mutate(fecha.l4 = add_with_rollback(fecha, months(-12)), 
         yr = year(fecha)) %>% 
  left_join(data %>% select(fecha, pibr), 
            by = c("fecha.l4" = "fecha")) %>% 
  mutate(pibr.l4 = pibr) %>% 
  select(-pibr) %>% 
  mutate(pibr = exp(log(pibr.l4) + valor))

cpib_2021 <- pred_cpib_long %>% 
  group_by(yr, tipo) %>% 
  summarize(crec.anual = log(sum(pibr)) - log(sum(pibr.l4)))

#Desarrollo del sistema financiero
pred_des.sf <- proy_2021 %>% 
  filter(fecha > "2020-12-01") %>% 
  select(fecha) %>% 
  bind_cols(pred_base_2021$fcst$des.sf %>% as_tibble) %>%
  select(-CI) %>% 
  bind_rows(tibble(fecha = date("2020-12-01"), 
                   fcst = data %>%
                     select(fecha, des.sf) %>% 
                     filter(fecha == "2020-12-01") %>% 
                     select(-fecha) %>% 
                     as.numeric(), 
                   lower = fcst, 
                   upper = fcst))

estimaciones_2021_trim <- tibble(pred_cpib) %>% 
  left_join(pred_des.sf, by = "fecha") %>% 
  pivot_longer(-fecha) %>% 
  mutate(value = round(value, 2)) %>% 
  pivot_wider(fecha)

estimaciones_2021 <- tibble(Variable = c("Crecimiento económico", "Desarrollo del S.F."), 
                            BCCR = c(0.039, NA), 
                            "Estimación" = round(c(as.numeric(cpib_2021[4, 3]), 
                                             as.numeric(pred_des.sf[4, 2])), 4), 
                            "Límite Inferior" = round(c(as.numeric(cpib_2021[5, 3]), 
                                                  as.numeric(pred_des.sf[4, 3])), 4), 
                            "Límite Superior" = round(c(as.numeric(cpib_2021[6, 3]),
                                                  as.numeric(pred_des.sf[4, 4])), 4))

df_2021 <- tibble("Estimación" = as.numeric(pred_des.sf[4, 2]),
                  "Límite Inferior" = as.numeric(pred_des.sf[4, 3]), 
                  "Límite Superior" = as.numeric(pred_des.sf[4, 4]))
```

.pull-left.w55[
```{r, echo=FALSE}

estimaciones_2021_trim <- tibble(pred_cpib) %>% 
  left_join(pred_des.sf, by = "fecha") %>% 
  pivot_longer(-fecha) %>% 
  mutate(value = round(value, 2)) %>% 
  pivot_wider(fecha)

kable(estimaciones_2021_trim, 
             caption = "Trimestral",
             col.names = c("fecha", rep(c("Estimación", "Lim. inferior", "Lim.superior"), 2))) %>% 
  kable_classic("hover", font_size = 13) %>%
  add_header_above(c("","Crecimiento Económico" = 3, "Desarrollo del Sistema Financiero" = 3)) %>% 
  column_spec(1, width = "10cm") 

```
]

.pull-right.w35[
```{r, echo=FALSE}

kable(estimaciones_2021, booktabs = TRUE,
             caption = "Anual") %>% 
  kable_classic("hover", font_size = 13) %>% 
  add_header_above(c("","", "Modelo VAR" = 3)) 

```
]

---

### Análisis de Sensibilidad    

**Procedimiento:**

* Por cada rango de cuantil, para cada covariable, se generó 100 observaciones, manteniendo los valores del escenario base para las demás covariables.

* Con los datos generados para las covariables, se estiman los valores empleando el modelo VAR.

* Los resultados se comparan con el escenario base.

--

```{r, echo = FALSE, message=FALSE}

#tabla con percentiles de covariables

rng_cuantil <- seq(0, 1, 0.2)

ultima_fecha <- data$fecha[nrow(data)]
ultima_tendencia <- var$datamat$trend[nrow(var$datamat)]

set.seed(21921)
n.iter <- 100
#Generación de data simulada
data_sim1 <- tibble(l.inf = rep(rng_cuantil[-length(rng_cuantil)],  n.iter),
                    l.sup = l.inf + 0.2,
                    Rango = paste(round(l.inf, 2), paste("-", round(l.sup, 2))),
                    covariable = list(c("apert_comercial", "cpib.usa", 
                                        "inflacion", "tbp", "vartc"))) %>%
  unnest(covariable) %>% 
  mutate(iter = 1:n()) %>% 
  mutate(data = pmap(list("variable" = covariable, "q.inf" = l.inf, "q.sup" = l.sup),
                     generar_datos_sim1)) %>%
  mutate(data = pmap(list("variable" = covariable, "q.inf" = l.inf, "q.sup" = l.sup),
                     generar_datos_sim1)) %>%
  group_by(iter) %>% 
  mutate(var_pred = map(data, ~ predict(var, dumvar = ., n.ahead = 4)$fcst)) 

#Predicciones desagregadas
pred_sim1 <- data_sim1 %>% 
  unnest(var_pred) %>% 
  mutate(y = rep(c("cpib.cri", "des.sf"), n() / 2)) %>%  
  unnest(var_pred) %>% 
  mutate(periodo = rep(c(1:4), n() / 4), 
         fecha = add_with_rollback(ultima_fecha, months(periodo * 3)), 
         fecha.l4 = add_with_rollback(fecha, months(-12))) %>% 
  select(-periodo) %>% 
  mutate(estimado = var_pred[, 1], 
         ic.inf = var_pred[, 2], 
         ic.sup = var_pred[, 3]) %>% 
  select(-var_pred) %>% 
  left_join(data %>% select(fecha, pibr), by = c("fecha.l4" = "fecha")) %>% 
  mutate(pibr.l4 = pibr) %>% 
  select(-pibr) %>% 
  mutate(pibr = ifelse(y == "cpib.cri", exp(estimado + log(pibr.l4)), NA), 
         des.sf = ifelse(y == "des.sf", estimado, NA), 
         tipo = "estimado") %>% 
  ungroup()

crec_mat <- pred_sim1 %>% 
  filter(y == "cpib.cri") %>% 
  select(iter, Rango, covariable, fecha, fecha.l4, pibr, pibr.l4) %>% 
  group_by(iter, covariable, Rango) %>% 
  summarize(crec.anual = log(sum(pibr)) - log(sum(pibr.l4))) %>%  
  group_by(Rango, covariable) %>% 
  summarize(mediana = round(median(crec.anual), 4)) %>% 
  pivot_wider(Rango, names_from = covariable, values_from = mediana) %>% 
  ungroup()

crec_colores <- tibble(l.inf = as.numeric(cpib_2021[5, 3]), 
                       l.sup = as.numeric(cpib_2021[6, 3]))

#Tabla para documento
crec_mat %>% 
  kbl(booktabs = T, caption = "Medianas de estimación para Crecimiento Económico",
      col.names = c("Rango cuantil", "Apertura Comercial", "Crec. PIB USA", 
                    "Inflación", "Tasa de Interés", "Tipo de Cambio (Var. Interanual)")) %>%
  kable_classic("hover", font_size = 15, full_width = F) %>% 
  column_spec(1, width = "4em") %>% 
  column_spec(2, width = "7em", background = case_when(crec_mat$apert_comercial > crec_colores$l.sup ~ 'lightgreen',
                                                        crec_mat$apert_comercial < crec_colores$l.inf ~ 'indianred1',
                                                        TRUE ~ 'white')) %>% 
  column_spec(3, width = "7em",  background = case_when(crec_mat$cpib.usa > crec_colores$l.sup ~ 'lightgreen',
                                                         crec_mat$cpib.usa < crec_colores$l.inf ~ 'lightcoral',
                                                         TRUE ~ 'white')) %>% 
  column_spec(4, width = "7em", background = case_when(crec_mat$inflacion > crec_colores$l.sup ~ 'lightgreen',
                                                        crec_mat$inflacion < crec_colores$l.inf ~ 'lightcoral',
                                                        TRUE ~ 'white')) %>% 
  column_spec(5, width = "7em", background = case_when(crec_mat$tbp > crec_colores$l.sup ~ 'lightgreen',
                                                        crec_mat$tbp < crec_colores$l.inf ~ 'lightcoral',
                                                        TRUE ~ 'white')) %>% 
  column_spec(6, width = "7em", background = case_when(crec_mat$vartc > crec_colores$l.sup ~ 'lightgreen',
                                                        crec_mat$vartc < crec_colores$l.inf ~ 'lightcoral',
                                                        TRUE ~ 'white')) %>% 
  footnote(general = c(
    "> límite superior estimación del modelo VAR en escenario base (Verde)", 
    "< límite inferior estimación del modelo VAR en escenario base (Rojo)"),  
    general_title = "")
```

---

### Análisis de Sensibilidad

**Procedimiento:**

* Por cada rango de cuantil, para cada covariable, se generó 100 observaciones, manteniendo los valores del escenario base para las demás covariables.

* Con los datos generados para las covariables, se estiman los valores empleando el modelo VAR.

* Los resultados se comparan con el escenario base.


```{r, echo=FALSE, message=FALSE}

#Desarrollo del sistema financiero

des.sf_mat <- pred_sim1 %>% 
  filter(y == "des.sf") %>% 
  select(iter, Rango, covariable, fecha, des.sf) %>%
  filter(quarter(fecha) == 4) %>% 
  group_by(covariable, Rango) %>% 
  summarize(mediana = round(median(des.sf), 4)) %>% 
  pivot_wider(Rango, names_from = covariable, values_from = mediana) %>% 
  ungroup()

des.sf_colores <- tibble(l.inf = pred_base_2021$fcst$des.sf[4, 2], 
                         l.sup = pred_base_2021$fcst$des.sf[4, 3])

des.sf_mat %>% 
  kbl(booktabs = T, caption = "Medianas de estimación para Desarrollo del Sistema Financiero",
      col.names = c("Rango cuantil", 
                    "Apertura Comercial", 
                    "Crec. PIB USA", 
                    "Inflación", 
                    "Tasa de Interés", 
                    "Tipo de Cambio (Var. Interanual)")) %>%
  kable_classic("hover", font_size = 15, full_width = F) %>% 
  column_spec(1, width = "4em") %>% 
  column_spec(2, width = "7em", background = case_when(des.sf_mat$apert_comercial > des.sf_colores$l.sup ~ 'lightgreen',
                                                       des.sf_mat$apert_comercial < des.sf_colores$l.inf ~ 'indianred1',
                                                       TRUE ~ 'white')) %>% 
  column_spec(3, width = "7em", background = case_when(des.sf_mat$cpib.usa > des.sf_colores$l.sup ~ 'lightgreen',
                                                       des.sf_mat$cpib.usa < des.sf_colores$l.inf ~ 'lightcoral',
                                                       TRUE ~ 'white')) %>% 
  column_spec(4, width = "7em", background = case_when(des.sf_mat$inflacion > des.sf_colores$l.sup ~ 'lightgreen',
                                                       des.sf_mat$inflacion < des.sf_colores$l.inf ~ 'lightcoral',
                                                       TRUE ~ 'white')) %>% 
  column_spec(5, width = "7em", background = case_when(des.sf_mat$tbp > des.sf_colores$l.sup ~ 'lightgreen',
                                                       des.sf_mat$tbp < des.sf_colores$l.inf ~ 'lightcoral',
                                                       TRUE ~ 'white')) %>% 
  column_spec(6, width = "7em", background = case_when(des.sf_mat$vartc > des.sf_colores$l.sup ~ 'lightgreen',
                                                       des.sf_mat$vartc < des.sf_colores$l.inf ~ 'lightcoral',
                                                       TRUE ~ 'white')) %>% 
  footnote(general = c(
    "> límite superior estimación del modelo VAR en escenario base (Verde)", 
    "< límite inferior estimación del modelo VAR en escenario base (Rojo)"),  
    general_title = "")

```

---

### Escenario de estrés económico

**Supuestos:**

.small[
* Se simula un escenario de crisis interna ocasionado por un deterioro de la situación fiscal: 
  + Aumento en tasas de interés
  + Alta inflación
  + Alta volatilidad en el tipo de cambio
  
* Se generó 100 escenarios incluyendo valores mayores al percentil 80 de los datos históricos en las tres variables. 

* Se consideran los valores del escenario base para el crecimiento del PIB de EUA y el indicador de apertura comercial.
]

--

```{r, echo = FALSE, fig.width = 9, fig.height = 4.25 , fig.align = 'center'}
ultima_fecha <- data$fecha[nrow(data)]
ultima_tendencia <- var$datamat$trend[nrow(var$datamat)]

set.seed(130618)
data_sim2 <- tibble(iter = 1:100) %>% 
  mutate(apert_comercial = rep(escen_base %>% select(`Apertura Comercial`), 100), 
         cpib.usa = rep(escen_base %>% select(`PIB USA`), 100),
         inflacion = map(iter, ~ generar_datos_sim2(data, inflacion, 0.80, 1)),
         tbp = map(iter, ~ generar_datos_sim2(data, tbp, 0.80, 1)),
         vartc = map(iter, ~ generar_datos_sim2(data, vartc, 0.80, 1)),
         determ = map(iter, ~ generar_determ(ultima_fecha, ultima_tendencia))) %>%
  unnest(-c(iter)) %>% 
  nest(data_var = apert_comercial:est.d4, 
       data_vecm = apert_comercial:tendencia)

pred2 <- data_sim2 %>%
  summarize(iter = iter,
            var_pred = map(data_var, ~ predict(var, dumvar = .,
                                               n.ahead = 4)$fcst), 
            vecm_pred = map(data_vecm, ~predict(vecm.level, 
                                                dumvar = as.matrix(.),
                                                n.ahead = 4)$fcst)) %>% 
  unnest(c(var_pred, vecm_pred)) %>% 
  mutate(y = rep(c("cpib.cri", "des.sf"), n() / 2)) %>%  
  unnest(c(var_pred, vecm_pred)) %>% 
  pivot_longer(-c(iter, y), names_sep = "_", names_to = c("mod", "pred")) %>% 
  select(-pred) 

sim2_cpib <- pred2 %>% filter(y == "cpib.cri") %>% 
  select(-y) %>%
  mutate(periodo = rep(c(rep(1, 2), rep(2, 2), rep(3, 2), rep(4, 2)), n() / 8), 
         fecha = add_with_rollback(ultima_fecha, months(periodo * 3)), 
         fecha.l4 = add_with_rollback(fecha, months(-12))) %>% 
  left_join(data %>% select(fecha, pibr), by = c("fecha.l4" = "fecha")) %>% 
  select(-periodo) %>% 
  mutate(pibr.l4 = pibr) %>% 
  select(-pibr) %>% 
  mutate(`estimación puntual` = value[, 1], 
         l.inf = value[, 2], 
         l.sup = value[, 3]) %>% 
  select(-value) %>% 
  pivot_longer(-c(iter, mod, fecha, fecha.l4, pibr.l4), 
               names_to = "tipo", values_to = "cpib.cri") %>% 
  mutate(pibr = exp(cpib.cri + log(pibr.l4)))

cpib_data <- data %>% 
  select(fecha, pibr, cpib.cri) %>% 
  mutate(iter = NA,
         mod = "real",
         tipo = NA,
         fecha = fecha,
         pibr = pibr, 
         cpib.cri = cpib.cri) %>% 
  relocate(c(iter, mod), .before = fecha) %>% 
  bind_rows(sim2_cpib %>% select(iter, mod, fecha, tipo, pibr, cpib.cri)) %>% 
  mutate(fecha.l4 = add_with_rollback(fecha, months(-12)), 
         año = year(fecha)) %>% 
  left_join(data %>% select(fecha, pibr) %>% 
              summarize(fecha = fecha, 
                        pibr.l4 = pibr),
            by = c("fecha.l4" = "fecha")) %>% 
  group_by(mod, año, tipo, iter) %>% 
  mutate(cpib.anual = log(sum(pibr)) - log(sum(pibr.l4))) 

cpib_proy_sim2 <- cpib_data %>% 
  filter(mod == "var", 
         tipo == "estimación puntual") %>% 
  group_by(fecha) %>% 
  summarize('máximo' = max(cpib.cri), 
            'mediana' = median(cpib.cri), 
            'mínimo' = min(cpib.cri)) %>% 
  bind_rows(tibble(fecha = date("2020-12-01"), 
                   'máximo' = data %>%
                     select(fecha, cpib.cri) %>% 
                     filter(fecha == "2020-12-01") %>% 
                     select(-fecha) %>% 
                     as.numeric(), 
                   mediana = `máximo`, 
                   mínimo = `máximo`))

cpib_anual_proy_sim2 <- cpib_data %>% 
  filter(mod == "var", 
         tipo == "estimación puntual") %>% 
  group_by(año) %>% 
  summarize('máximo' = max(cpib.anual), 
            'mediana' = median(cpib.anual), 
            'mínimo' = min(cpib.anual)) %>% 
  bind_rows(tibble("año" = 2020, 
                   'máximo' = cpib_data %>%
                     ungroup() %>% 
                     select(fecha, cpib.anual) %>% 
                     filter(fecha == "2020-12-01") %>% 
                     select(-fecha) %>% 
                     as.numeric(), 
                   mediana = `máximo`, 
                   mínimo = `máximo`))

ggplot() + 
  geom_line(data = cpib_data %>% 
              filter(mod == "real", `año` > 2000),
            aes(x = `año`, y = cpib.anual)) +
  geom_ribbon(data = cpib_anual_proy_sim2, aes(x = `año`, ymax = `máximo`, ymin = `mínimo`, fill = "Escenario Estrés")) +
  geom_line(data = cpib_2021 %>% filter(tipo == "upper"), aes(y = crec.anual, x = yr, colour = "IC Escenario Base"), linetype = "dashed") +
  geom_line(data = cpib_2021 %>% filter(tipo == "lower"), aes(y = crec.anual, x = yr, colour = "IC Escenario Base"), linetype = "dashed") +
  scale_color_manual(values = c(`IC Escenario Base` = "blue")) +
  scale_fill_manual(values = c(`Escenario Estrés` = "grey70")) +                  
  ylab("Crecimiento Económico") +
  ggtitle("Crecimiento económico anual y el intervalo de predicción del escenario estresado para 2021") + 
  theme_classic() %+replace% 
  theme(legend.text = element_text(size = 11),
        plot.title = element_text(size = 12),
        axis.title = element_text(size = 11), 
        axis.text=element_text(size = 11), 
        strip.text.y = element_text(size = 11),
        legend.position = "bottom",
        legend.title = element_blank(),
        panel.grid.major.y = element_line(color = "grey70",
                                          size = 0.5, 
                                          linetype = 2))
```

---

### Escenario de estrés económico

**Supuestos:**

.small[
* Se simula un escenario de crisis interna ocasionado por un deterioro de la situación fiscal: 
  + Aumento en tasas de interés
  + Alta inflación
  + Alta volatilidad en el tipo de cambio
  
* Se generó 100 escenarios incluyendo valores mayores al percentil 80 de los datos históricos en las tres variables. 

* Se consideran los valores del escenario base para el crecimiento del PIB de EUA y el indicador de apertura comercial.
]

```{r, r, echo = FALSE, fig.width = 9, fig.height = 4.25 , fig.align = 'center'}

#Desarrollo del Sistema Financiero
sim2_des.sf <- pred2 %>% filter(y == "des.sf") %>% 
  select(-y) %>%
  mutate(periodo = rep(c(rep(1, 2), rep(2, 2), rep(3, 2), rep(4, 2)), n() / 8), 
         fecha = add_with_rollback(ultima_fecha, months(periodo * 3))) %>% 
  select(-periodo) %>% 
  mutate(`estimación puntual` = value[, 1], 
         l.inf = value[, 2], 
         l.sup = value[, 3]) %>% 
  select(-value) %>% 
  pivot_longer(-c(iter, mod, fecha), names_to = "tipo", values_to = "des.sf")

des.sf_data <- data %>% 
  select(fecha, des.sf) %>% 
  mutate(iter = NA,
         mod = "real",
         fecha = fecha) %>% 
  relocate(iter, .before = fecha) %>% 
  bind_rows(sim2_des.sf %>% select(iter, mod, fecha, tipo, des.sf)) %>% 
  mutate(fecha.l4 = add_with_rollback(fecha, months(-12)), 
         año = year(fecha)) %>% 
  left_join(data %>% select(fecha, des.sf) %>% 
              summarize(fecha = fecha, 
                        des.sf.l4 = des.sf), 
            by = c("fecha.l4" = "fecha")) 

ds_proy_sim2 <- des.sf_data %>% 
  filter(mod == "var", 
         tipo == "estimación puntual") %>% 
  group_by(fecha) %>% 
  summarize('máximo' = max(des.sf), 
            'mediana' = median(des.sf), 
            'mínimo' = min(des.sf)) %>% 
  bind_rows(tibble(fecha = date("2020-12-01"), 
                   'máximo' = data %>%
                     select(fecha, des.sf) %>% 
                     filter(fecha == "2020-12-01") %>% 
                     select(-fecha) %>% 
                     as.numeric(), 
                   mediana = `máximo`, 
                   mínimo = `máximo`))

ggplot() + 
  geom_line(data = des.sf_data %>% filter(mod == "real", fecha > "2010-01-01"),
            aes(x = fecha, y = des.sf)) +
  geom_ribbon(data = ds_proy_sim2, aes(x = fecha, ymax = `máximo`, ymin = `mínimo`, fill = "Escenario Estrés")) +
  geom_line(data = pred_des.sf, aes(y = upper, x = fecha, colour = "IC Escenario Base"), linetype = "dashed") +
  geom_line(data = pred_des.sf, aes(y = lower, x = fecha, colour = "IC Escenario Base"), linetype = "dashed") +
  scale_color_manual(values = c(`IC Escenario Base` = "blue")) +
  scale_fill_manual(values = c(`Escenario Estrés` = "grey70")) +
  ylab("Desarrollo del Sist. Financiero") +
  ggtitle("Desarrollo del S.F. y el intervalo de predicción del escenario estresado para 2021") + 
  theme_classic() %+replace% 
  theme(legend.text = element_text(size = 11),
        plot.title = element_text(size = 12),
        axis.title = element_text(size = 11), 
        axis.text=element_text(size = 11), 
        strip.text.y = element_text(size = 11),
        legend.position = "bottom",
        legend.title = element_blank(),
        panel.grid.major.y = element_line(color = "grey70",
                                          size = 0.5, 
                                          linetype = 2))
```

---

class: inverse, center, middle

# CONCLUSIONES

---

<br>
+ Se aporta evidencia estadísticamente significatica sobre el nexo entre crecimiento económico y desarrollo del sistema financiero.  

<br>
+  La respuesta del crecimiento económico a un shock en el desarrollo del sistema financiero es estadísticamente significativo.   

<br>
+ Los resultados de las funciones impulso-respuesta del desarrollo del sistema financiero a un impulso en el crecimiento económico difieren entre el VAR y el VECM.   

<br>
+ La prueba de causalidad aporta evidencia sobre la relación de causalidad (en el sentido de Granger) bidireccional entre las variables.

<br>
+ En el contexto económico actual caracterizado por la alta incertidumbre, resulta fundamental contar con herramientas que permitan diseñar distintos escenarios y que sirvan de apoyo para la toma de decisiones.

---

class: inverse, center, middle

# GRACIAS